ПЛАН РЕАЛИЗАЦИИ МЕХАНИКИ ЗАПИСИ КЛИЕНТА НА ТРЕНИРОВКИ
================================================================================

ОБЩАЯ ИНФОРМАЦИЯ:
- Telegram-бот будет отдельным проектом
- Уведомления отправляются только через Telegram-бота
- Повторяющиеся тренировки создаются по мере необходимости (не все сразу)
- Аутентификация в боте: требуется решение (см. варианты ниже)

================================================================================
ЭТАП 1: БАЗОВАЯ МОДЕЛЬ ТРЕНИРОВКИ (TRAINING/BOOKING)
================================================================================

1.1. Создать модель final.training.booking
   Файл: final/models/final_training_booking.py
   
   Поля модели:
   - name (Char, computed) - описание тренировки
   - sport_center_id (Many2one → final.sport.center) - обязательное
   - tennis_court_id (Many2one → final.tennis.court) - обязательное
   - trainer_id (Many2one → hr.employee) - обязательное
   - training_type_id (Many2one → final.training.type) - обязательное
   - client_ids (Many2many → res.partner) - клиенты на тренировке
   - start_datetime (Datetime) - дата и время начала
   - end_datetime (Datetime) - дата и время окончания
   - duration_hours (Float, computed) - продолжительность в часах
   - state (Selection) - статусы: draft, pending_approval, confirmed, completed, cancelled
   - created_by (Many2one → res.users) - кто создал запись
   - approved_by (Many2one → res.users) - кто одобрил (если требуется)
   - approved_date (Datetime) - дата одобрения
   - total_price (Monetary, computed) - общая стоимость тренировки
   - trainer_rate_amount (Monetary, computed) - ставка тренера за тренировку
   - profit_amount (Monetary, computed) - прибыль (цена минус ставка)
   - recurring_id (Many2one → final.training.recurring) - ссылка на повторяющуюся тренировку
   - is_recurring (Boolean) - флаг повторяющейся тренировки
   - currency_id (Many2one → res.currency) - валюта
   - telegram_notification_sent (Boolean) - флаг отправки уведомления через бота
   - reminder_sent (Boolean) - флаг отправки напоминания

1.2. Валидации модели:
   - Проверка пересечения времени в пределах одного корта
   - Проверка количества клиентов по типу тренировки (min_clients, max_clients)
   - Проверка рабочих часов корта (work_time_start, work_time_end)
   - Минимальная длительность 1 час, шаг кратен 1 часу
   - Проверка баланса клиента перед подтверждением
   - Проверка привязки тренера к СЦ

1.3. Методы модели:
   - _compute_name() - генерация описания тренировки
   - _compute_duration_hours() - расчет продолжительности
   - _compute_total_price() - расчет общей стоимости
   - _compute_trainer_rate_amount() - расчет ставки тренера
   - _compute_profit_amount() - расчет прибыли
   - action_confirm() - подтверждение тренировки
   - action_complete() - завершение тренировки (списание баланса)
   - action_cancel() - отмена тренировки
   - action_approve() - одобрение менеджером

1.4. Создать базовые views:
   - Форма (form view)
   - Список (tree view)
   - Календарь (calendar view) - на этапе 6
   - Фильтры и группировки

1.5. Добавить в __manifest__.py:
   - models/final_training_booking.py
   - views/final_training_booking_views.xml

1.6. Добавить права доступа в ir.model.access.csv

================================================================================
ЭТАП 2: WIZARD ДЛЯ ЗАПИСИ НА ТРЕНИРОВКУ
================================================================================

2.1. Создать модель final.training.booking.wizard
   Файл: final/wizard/training_booking_wizard.py
   
   Поля wizard:
   - sport_center_id (Many2one → final.sport.center) - выбор СЦ
   - tennis_court_id (Many2one → final.tennis.court) - выбор корта
   - training_type_id (Many2one → final.training.type) - тип тренировки
   - trainer_id (Many2one → hr.employee) - тренер
     * Автозаполнение для тренера (текущий пользователь)
     * Выбор для менеджера
   - date (Date) - дата тренировки
   - start_time (Float) - время начала (часы)
   - duration (Float) - продолжительность (1, 2, 3... часов)
   - client_ids (Many2many → res.partner) - выбор клиентов
   - is_recurring (Boolean) - повторяющаяся тренировка
   - recurring_end_date (Date) - дата окончания повтора
   - recurring_days_of_week (Selection) - дни недели для повтора

2.2. Логика wizard:
   - default_get() - автозаполнение trainer_id для тренера
   - onchange для обновления доступных слотов
   - Метод получения занятых слотов для выбранного корта и даты
   - Валидация количества клиентов по типу тренировки
   - Проверка доступности времени

2.3. Метод action_create_booking():
   - Создание записи final.training.booking
   - Если тренер создал → state = 'pending_approval'
   - Если менеджер создал → state = 'confirmed'
   - Если повторяющаяся → создание связанной записи final.training.recurring

2.4. Создать view для wizard:
   - Форма с таймлайн-визуализацией занятости корта
   - Календарь выбора даты
   - Список доступных временных слотов
   - Список клиентов с фильтрами и поиском

2.5. Добавить кнопку "Записаться" в меню и формы

================================================================================
ЭТАП 3: СИСТЕМА АПРУВОВ
================================================================================

3.1. Расширить модель final.training.booking:
   - Логика смены статусов при создании
   - Метод action_approve() для менеджера
   - Метод action_reject() для отклонения

3.2. Создать меню для менеджера:
   - "Запросы на одобрение" (только записи со статусом pending_approval)
   - Фильтр по своему СЦ

3.3. Логика workflow:
   - Тренер создает запись → state = 'pending_approval'
   - Менеджер одобряет → state = 'confirmed', записывается approved_by, approved_date
   - Менеджер отклоняет → state = 'draft' или 'cancelled'
   - Менеджер создает запись → state = 'confirmed' (без апрува)

3.4. Уведомления:
   - Уведомление менеджеру при создании записи тренером (Odoo notification)
   - Уведомление тренеру при одобрении/отклонении

3.5. Ограничения:
   - Тренер может отменять/изменять только свои записи со статусом pending_approval
   - После подтверждения изменения требуют апрува менеджера

================================================================================
ЭТАП 4: БАЛАНС КЛИЕНТА И СПИСАНИЕ
================================================================================

4.1. Расширить модель res.partner:
   Файл: final/models/res_partner.py
   
   Новые поля:
   - balance (Monetary) - текущий баланс
   - currency_id (Many2one → res.currency) - валюта баланса
   - training_booking_ids (One2many → final.training.booking, client_id)
   - balance_history_ids (One2many → final.balance.transaction)

4.2. Создать модель final.balance.transaction:
   Файл: final/models/final_balance_transaction.py
   
   Поля:
   - partner_id (Many2one → res.partner)
   - transaction_type (Selection) - пополнение/списание
   - amount (Monetary)
   - booking_id (Many2one → final.training.booking)
   - date (Datetime)
   - description (Char)

4.3. Логика списания:
   - При завершении тренировки (action_complete())
   - Расчет суммы: price_per_hour * duration_hours для каждого клиента
   - Списание с баланса всех клиентов
   - Создание записей final.balance.transaction
   - Проверка баланса перед подтверждением записи

4.4. Ограничения при записи:
   - Проверка баланса клиента в wizard
   - Предупреждение если баланс недостаточен
   - Блокировка записи если баланс меньше необходимой суммы

4.5. View для пополнения баланса:
   - Wizard пополнения (только для менеджера)
   - История транзакций клиента
   - Отображение баланса в карточке клиента

================================================================================
ЭТАП 5: ПОВТОРЯЮЩИЕСЯ ТРЕНИРОВКИ
================================================================================

5.1. Создать модель final.training.recurring:
   Файл: final/models/final_training_recurring.py
   
   Поля:
   - name (Char)
   - sport_center_id (Many2one → final.sport.center)
   - tennis_court_id (Many2one → final.tennis.court)
   - trainer_id (Many2one → hr.employee)
   - training_type_id (Many2one → final.training.type)
   - client_ids (Many2many → res.partner)
   - start_date (Date) - дата начала повтора
   - end_date (Date) - дата окончания повтора
   - day_of_week (Selection) - дни недели [Понедельник, Вторник, ...]
   - time_start (Float) - время начала (часы)
   - duration (Float) - продолжительность
   - frequency (Selection) - ежедневно/еженедельно/раз в 2 недели
   - booking_ids (One2many → final.training.booking, recurring_id)
   - active (Boolean) - активность

5.2. Методы модели:
   - generate_bookings() - генерация записей на основе параметров
   - Метод вызывается вручную или по cron (например, раз в неделю)
   - Проверка пересечений перед созданием
   - Создание записей со статусом pending_approval если создал тренер

5.3. View для повторяющихся тренировок:
   - Форма для создания/редактирования
   - Список сгенерированных тренировок
   - Кнопка "Сгенерировать записи"

5.4. Cron-задача (опционально):
   - Автоматическая генерация записей на следующую неделю
   - Запуск каждую неделю

================================================================================
ЭТАП 6: КАЛЕНДАРНОЕ ПРЕДСТАВЛЕНИЕ
================================================================================

6.1. Calendar view для final.training.booking:
   - Группировка по кортам
   - Цветовая индикация по статусам/типам тренировок
   - Отображение тренера и клиентов в tooltip

6.2. Фильтры:
   - По тренеру (для тренера - только свои)
   - По корту
   - По СЦ
   - По дате
   - По статусу

6.3. Права доступа:
   - Тренер видит только свои тренировки
   - Менеджер видит тренировки своего СЦ
   - Директор видит все

6.4. Добавить в меню:
   - "Расписание" для тренера
   - "Расписание" для менеджера (с фильтрами по СЦ)

================================================================================
ЭТАП 7: REST API ДЛЯ TELEGRAM БОТА
================================================================================

7.1. Создать контроллер final/controllers/tg_bot_api.py:
   - @http.route('/api/tg/balance', auth='public', methods=['POST'])
   - @http.route('/api/tg/trainings', auth='public', methods=['POST'])
   - @http.route('/api/tg/notify', auth='public', methods=['POST']) - для отправки уведомлений

7.2. Аутентификация:
   - Token-based authentication
   - Валидация токена в каждом запросе
   - Хранение токена в настройках системы или конфигурации

7.3. Endpoints:
   - GET /api/tg/balance - получение баланса клиента
     Параметры: telegram_user_id или token
     Возврат: balance, currency
   
   - GET /api/tg/trainings - получение предстоящих тренировок
     Параметры: telegram_user_id или token
     Возврат: список тренировок с деталями (дата, время, СЦ, корт, тренер)
   
   - POST /api/tg/notify - отправка уведомления клиенту
     Параметры: partner_id, message, notification_type
     Вызов от Telegram-бота для отправки уведомлений

7.4. Добавить поле в res.partner:
   - telegram_user_id (Integer) - ID пользователя в Telegram
   - telegram_token (Char) - токен для аутентификации (опционально)

7.5. Безопасность:
   - Проверка токена
   - Ограничение частоты запросов (rate limiting)
   - Логирование запросов

================================================================================
ЭТАП 8: TELEGRAM БОТ (ОТДЕЛЬНЫЙ ПРОЕКТ)
================================================================================

8.1. Архитектура бота:
   - Python + python-telegram-bot или aiogram
   - Отдельный сервер/процесс
   - Подключение к Odoo через REST API (этап 7)

8.2. Функционал бота:
   - /start - регистрация/привязка аккаунта
   - /balance - текущий баланс
   - /my_trainings - предстоящие тренировки
   - /help - помощь

8.3. Уведомления:
   - При создании записи на тренировку
   - Напоминание за N часов до начала (настраивается в Odoo)
   - При изменении/отмене тренировки

8.4. Интеграция с Odoo:
   - Cron-задача в Odoo для отправки напоминаний
   - Cron проверяет предстоящие тренировки и отправляет через API бота

8.5. Аутентификация:
   - ВЫБРАН: Вариант 2 - Привязка вручную менеджером (см. описание ниже)

================================================================================
ЭТАП 9: СИСТЕМА УВЕДОМЛЕНИЙ И НАПОМИНАНИЙ
================================================================================

9.1. Cron-задача для напоминаний:
   Файл: final/models/final_training_booking.py (метод или отдельный метод)
   
   Логика:
   - Поиск тренировок со статусом 'confirmed'
   - Проверка времени до начала (за N часов)
   - Отправка уведомлений через Telegram Bot API
   - Отметка reminder_sent = True

9.2. Настройки:
   - Поле в настройках системы для времени напоминания (N часов)
   - Интервал запуска cron (например, каждый час)

9.3. Уведомления при событиях:
   - При создании записи → отправка клиентам через бота
   - При изменении/отмене → уведомление через бота
   - При одобрении/отклонении → уведомление тренеру

9.4. Интеграция с Telegram Bot:
   - Odoo вызывает API бота для отправки уведомлений
   - Или бот периодически опрашивает Odoo через REST API

================================================================================
ЭТАП 10: ОТЧЕТНОСТЬ И СТАТИСТИКА
================================================================================

10.1. Отчет "Самый прибыльный тренер":
   - Модель: wizard или computed fields
   - Фильтр по датам
   - Группировка по тренерам
   - Суммирование profit_amount

10.2. Отчет "Самый посещаемый вид тренировки":
   - Подсчет количества тренировок по типам
   - Фильтр по датам

10.3. Отчет "Самый активный клиент":
   - Подсчет количества тренировок по клиентам
   - Фильтр по датам

10.4. PDF отчет по прибыли:
   - Wizard для выбора СЦ и диапазона дат
   - Генерация PDF через отчеты Odoo
   - Доступ только для директора

10.5. View для отчетов:
   - Графики и сводные таблицы
   - Экспорт в Excel/PDF

================================================================================
ЭТАП 11: ПРАВА ДОСТУПА И ОГРАНИЧЕНИЯ
================================================================================

11.1. Обновить ir.model.access.csv:
   - Права для final.training.booking
   - Права для final.training.recurring
   - Права для final.balance.transaction
   - Права для wizard моделей

11.2. Обновить final_security.xml:
   - Record rules для тренера (только свои записи)
   - Record rules для менеджера (только свой СЦ)
   - Record rules для директора (все записи)

11.3. Ограничения по ролям:
   - Тренер:
     * Видит только свои тренировки
     * Не видит финансовую информацию (баланс клиента, прибыль)
     * Не может пополнять баланс
     * Требуется апрув для создания/изменения записей
   
   - Менеджер:
     * Видит тренировки своего СЦ
     * Видит финансовую информацию (кроме ставок тренеров п.10)
     * Может пополнять баланс клиентов
     * Не может печатать отчет по прибыли
     * Одобряет/отклоняет записи тренеров
   
   - Директор:
     * Видит все тренировки
     * Видит всю финансовую информацию
     * Может печатать отчеты

================================================================================
АУТЕНТИФИКАЦИЯ В TELEGRAM БОТЕ (ВАРИАНТ 2 - ВЫБРАН)
================================================================================

ВЫБРАННЫЙ МЕТОД: ПРИВЯЗКА ВРУЧНУЮ МЕНЕДЖЕРОМ

Описание процесса:
1. Клиент сообщает менеджеру свой Telegram username (@username) или номер телефона
2. Менеджер находит клиента в Odoo по имени/телефону
3. Менеджер получает Telegram User ID клиента одним из способов:
   а) Клиент использует бота @userinfobot - пишет ему /start, получает свой ID, сообщает менеджеру
   б) Клиент пишет /start в нашем боте, бот показывает ID, клиент сообщает менеджеру
4. Менеджер вводит Telegram User ID в карточку клиента в Odoo
5. После привязки клиент может использовать бота (проверка баланса, просмотр тренировок)

Реализация:
1. Расширить res.partner:
   - telegram_user_id (Integer) - Telegram User ID (заполняется менеджером)
   - telegram_username (Char) - Telegram username (опционально, для удобства)
   
2. В карточке клиента (res.partner):
   - Поле "Telegram User ID" (видимо только для менеджера/директора)
   - Поле "Telegram Username" (опционально)
   - Инструкция: "Для получения ID попросите клиента написать @userinfobot или /start в нашем боте"

3. В Telegram боте:
   - Команда /start - проверяет наличие telegram_user_id в Odoo
   - Если telegram_user_id найден и совпадает → активация бота
   - Если не найден → сообщение: "Ваш аккаунт не привязан. Обратитесь к менеджеру"
   - Команда /get_my_id - показывает свой Telegram User ID (если еще не привязан)

4. Валидация:
   - При сохранении telegram_user_id проверка на уникальность
   - Telegram User ID должен быть положительным числом

Преимущества выбранного метода:
+ Полный контроль менеджера над привязкой аккаунтов
+ Можно привязать без активного участия клиента в боте
+ Простая реализация без дополнительных моделей

Инструкция для менеджера:
1. Клиент сообщает вам свой Telegram username или просит помочь с привязкой
2. Откройте карточку клиента в Odoo
3. Попросите клиента написать @userinfobot в Telegram и отправить вам полученный ID
4. Введите полученный ID в поле "Telegram User ID"
5. Сохраните карточку клиента
6. Клиент теперь может использовать бота

================================================================================
ПОСЛЕДОВАТЕЛЬНОСТЬ РЕАЛИЗАЦИИ
================================================================================

Приоритет 1 (Базовый функционал):
1. Этап 1: Базовая модель тренировки
2. Этап 2: Wizard для записи
3. Этап 3: Система апрувов
4. Этап 11: Права доступа

Приоритет 2 (Финансы):
5. Этап 4: Баланс клиента и списание

Приоритет 3 (Удобство):
6. Этап 6: Календарное представление
7. Этап 5: Повторяющиеся тренировки

Приоритет 4 (Интеграция):
8. Этап 7: REST API для Telegram
9. Этап 9: Система уведомлений
10. Этап 8: Telegram бот (отдельный проект)

Приоритет 5 (Отчетность):
11. Этап 10: Отчетность и статистика

================================================================================
ВИЗУАЛЬНЫЙ АЛГОРИТМ РАБОТЫ ДЛЯ ТРЕНЕРА
================================================================================

СЦЕНАРИЙ 1: ЗАПИСЬ КЛИЕНТА НА ТРЕНИРОВКУ

Шаг 1: Вход в систему
   - Тренер заходит в Odoo под своим логином
   - Видит главное меню модуля "Final" (если модуль отображается в меню)

Шаг 2: Переход в раздел записи
   - Нажимает на меню "Записаться на тренировку" или кнопку "Новая запись"
   - Открывается wizard записи на тренировку

Шаг 3: Заполнение формы записи
   
   3.1. Выбор спортивного центра:
   - Поле "Спортивный центр" автоматически заполнено (только СЦ где работает тренер)
   - Можно выбрать другой свой СЦ из списка
   
   3.2. Выбор теннисного корта:
   - Поле "Теннисный корт" - выбор из кортов выбранного СЦ
   - При выборе корта отображается визуализация занятости (таймлайн)
   
   3.3. Выбор даты:
   - Календарь для выбора даты тренировки
   - Можно выбрать только будущие даты
   
   3.4. Выбор времени и продолжительности:
   - Поле "Время начала" - выбор времени (часы:минуты)
   - Поле "Продолжительность" - выбор 1, 2, 3... часов
   - Визуализация свободных/занятых слотов для выбранного корта и даты
   - Занятые слоты показаны красным/серым, свободные - зеленым
   - При наведении на занятый слот - подсказка: "Занято тренером X, клиент Y, время Z"
   
   3.5. Выбор типа тренировки:
   - Радиокнопки: "Индивидуальная", "Сплит", "Групповая"
   - При выборе типа автоматически обновляется список доступных клиентов
   
   3.6. Выбор тренера:
   - Поле "Тренер" автоматически заполнено текущим пользователем (тренером)
   - Нельзя изменить (readonly для тренера)
   
   3.7. Выбор клиентов:
   - Мультивыбор клиентов из списка
   - Количество клиентов зависит от типа:
     * Индивидуальная: ровно 1 клиент
     * Сплит: ровно 2 клиента
     * Групповая: от 3 до 5 клиентов
   - При неверном количестве - предупреждение
   - Показывается баланс каждого клиента (но сумма не показывается - ограничение прав)
   
   3.8. Повторяющаяся тренировка (опционально):
   - Чекбокс "Повторяющаяся тренировка"
   - При активации появляются дополнительные поля:
     * Дата окончания повтора
     * Дни недели (мультивыбор)
     * Частота (еженедельно, раз в 2 недели)

Шаг 4: Подтверждение и отправка на апрув
   - Нажимает кнопку "Создать запись"
   - Система проверяет:
     * Занятость корта
     * Рабочие часы корта
     * Количество клиентов
     * Достаточность баланса клиентов
   - При успехе создается запись со статусом "На одобрении" (pending_approval)
   - Появляется сообщение: "Запись создана и отправлена менеджеру на одобрение"

Шаг 5: Ожидание одобрения
   - Запись видна в разделе "Мои тренировки" со статусом "На одобрении"
   - Тренер видит уведомление когда менеджер одобрит/отклонит
   - После одобрения статус меняется на "Подтверждена" (confirmed)


СЦЕНАРИЙ 2: ПРОСМОТР РАСПИСАНИЯ

Шаг 1: Переход в раздел расписания
   - Нажимает на меню "Расписание" в своем кабинете
   - Открывается календарное представление

Шаг 2: Просмотр тренировок
   - Календарь показывает только свои тренировки
   - Фильтры:
     * По дате (сегодня, завтра, эта неделя, этот месяц)
     * По статусу (подтвержденные, на одобрении, отмененные)
   - Цветовая индикация:
     * Зеленый - подтвержденные
     * Желтый - на одобрении
     * Серый - отмененные/завершенные
   
Шаг 3: Просмотр деталей тренировки
   - Клик на событие в календаре
   - Открывается карточка тренировки с информацией:
     * Дата и время
     * Корт
     * Клиенты
     * Тип тренировки
     * Статус
   - НЕ показывается: баланс клиентов, стоимость, прибыль


СЦЕНАРИЙ 3: ОТМЕНА/ИЗМЕНЕНИЕ ТРЕНИРОВКИ

Шаг 1: Открытие карточки тренировки
   - В расписании или списке тренировок открывает нужную запись
   
Шаг 2: Изменение/отмена
   - Если статус "На одобрении" - может отменить без апрува
   - Если статус "Подтверждена" - изменение требует повторного апрува
   - Нажимает "Изменить" или "Отменить"
   - При изменении открывается форма редактирования (аналогично созданию)
   - При отмене - подтверждение, затем статус меняется на "Отменена"


СЦЕНАРИЙ 4: СОЗДАНИЕ ПОВТОРЯЮЩЕЙСЯ ТРЕНИРОВКИ

Шаг 1: Создание записи с повтором
   - В wizard записи активирует "Повторяющаяся тренировка"
   - Заполняет дату окончания повтора
   - Выбирает дни недели (например, среда и пятница)
   
Шаг 2: Генерация записей
   - После создания основной записи, нажимает "Сгенерировать повторения"
   - Система создает записи на все выбранные дни до даты окончания
   - Все созданные записи имеют статус "На одобрении"
   - Менеджер одобряет все записи одной операцией или по отдельности


================================================================================
ВИЗУАЛЬНЫЙ АЛГОРИТМ РАБОТЫ ДЛЯ МЕНЕДЖЕРА
================================================================================

СЦЕНАРИЙ 1: ЗАПИСЬ КЛИЕНТА НА ТРЕНИРОВКУ

Шаг 1: Вход в систему
   - Менеджер заходит в Odoo под своим логином
   - Видит главное меню модуля "Final"

Шаг 2: Переход в раздел записи
   - Нажимает на меню "Записаться на тренировку" или "Новая запись"
   - Открывается wizard записи на тренировку

Шаг 3: Заполнение формы (аналогично тренеру, но с отличиями)
   
   3.1. Выбор спортивного центра:
   - Поле автоматически заполнено его СЦ (readonly)
   
   3.2. Выбор теннисного корта:
   - Выбор из кортов своего СЦ
   - Визуализация занятости всех кортов
   
   3.3-3.7: Аналогично тренеру
   
   3.8. Выбор тренера:
   - Поле "Тренер" - выбор из всех тренеров своего СЦ
   - Может выбрать любого доступного тренера
   
   3.9. Выбор клиентов:
   - Показывается баланс каждого клиента в явном виде
   - Показывается стоимость тренировки
   - Предупреждение если баланс недостаточен

Шаг 4: Подтверждение
   - Нажимает "Создать запись"
   - Запись создается сразу со статусом "Подтверждена" (confirmed)
   - Апрув не требуется
   - Автоматически отправляется уведомление клиентам через Telegram


СЦЕНАРИЙ 2: ОДОБРЕНИЕ ЗАПИСЕЙ ТРЕНЕРОВ

Шаг 1: Просмотр запросов на одобрение
   - Нажимает на меню "Запросы на одобрение"
   - Открывается список всех записей со статусом "На одобрении"
   - Фильтры:
     * По дате
     * По тренеру
     * По корту

Шаг 2: Просмотр деталей запроса
   - Кликает на запись из списка
   - Открывается карточка тренировки с информацией:
     * Тренер
     * Дата и время
     * Корт
     * Тип тренировки
     * Клиенты и их балансы
     * Стоимость тренировки

Шаг 3: Одобрение или отклонение
   - Нажимает "Одобрить" - статус меняется на "Подтверждена"
   - Или "Отклонить" - открывается форма с причиной отклонения
   - После одобрения/отклонения тренер получает уведомление
   - Клиенты получают уведомление через Telegram (при одобрении)


СЦЕНАРИЙ 3: СОЗДАНИЕ/РЕДАКТИРОВАНИЕ КЛИЕНТА

Шаг 1: Переход к клиентам
   - Нажимает "Клиенты" в меню или в карточке СЦ
   - Открывается список всех клиентов СЦ

Шаг 2: Создание нового клиента
   - Нажимает "Создать"
   - Заполняет форму:
     * ФИО
     * Телефон
     * Email
     * Начальный баланс (можно оставить 0)
     * Telegram User ID (если клиент хочет использовать бота)
     * Telegram Username (опционально)
   - Сохраняет

Шаг 3: Пополнение баланса существующего клиента
   - Открывает карточку клиента
   - Нажимает "Пополнить баланс"
   - Вводит сумму
   - Выбирает способ оплаты (наличные, карта, перевод)
   - Сохраняет
   - В истории баланса появляется запись о пополнении


СЦЕНАРИЙ 4: ПРИВЯЗКА TELEGRAM АККАУНТА КЛИЕНТА

Шаг 1: Клиент обращается за привязкой
   - Клиент сообщает менеджеру что хочет использовать Telegram-бота
   
Шаг 2: Получение Telegram User ID
   - Менеджер инструктирует клиента:
     * Написать @userinfobot в Telegram
     * Отправить полученный ID менеджеру
   - Или клиент пишет /start в нашем боте и получает ID
   
Шаг 3: Ввод ID в систему
   - Менеджер открывает карточку клиента в Odoo
   - Вводит полученный Telegram User ID в поле "Telegram User ID"
   - Сохраняет карточку
   - Клиент теперь может использовать бота


СЦЕНАРИЙ 5: ПРОСМОТР РАСПИСАНИЯ СВОЕГО СЦ

Шаг 1: Переход в расписание
   - Нажимает "Расписание" в меню
   - Открывается календарь со всеми тренировками СЦ

Шаг 2: Фильтрация и просмотр
   - Фильтры:
     * По тренеру (может выбрать конкретного или все)
     * По корту
     * По дате
     * По статусу
   - Видит все тренировки всех тренеров своего СЦ
   - Цветовая индикация по статусам и тренерам

Шаг 3: Просмотр деталей
   - Клик на событие показывает полную информацию:
     * Тренер, клиенты
     * Стоимость, прибыль
     * Балансы клиентов
     * История изменений


СЦЕНАРИЙ 6: ЗАВЕРШЕНИЕ ТРЕНИРОВКИ И СПИСАНИЕ БАЛАНСА

Шаг 1: Открытие тренировки после ее проведения
   - В расписании находит прошедшую тренировку
   - Открывает карточку тренировки

Шаг 2: Завершение тренировки
   - Нажимает кнопку "Завершить тренировку"
   - Система рассчитывает сумму списания:
     * Цена за час * продолжительность * количество клиентов
   - Отображается сумма списания с каждого клиента
   - Подтверждает списание

Шаг 3: Автоматическое списание
   - Система списывает средства с баланса каждого клиента
   - Создаются записи в истории баланса
   - Статус тренировки меняется на "Завершена" (completed)
   - Рассчитывается прибыль (стоимость минус ставка тренера)
   - Запись появляется в отчетности


СЦЕНАРИЙ 7: СОЗДАНИЕ ПОВТОРЯЮЩЕЙСЯ ТРЕНИРОВКИ

Шаг 1: Создание основной записи
   - Аналогично обычной записи, но активирует "Повторяющаяся"
   
Шаг 2: Настройка параметров повтора
   - Дата окончания
   - Дни недели
   - Частота

Шаг 3: Генерация записей
   - Нажимает "Сгенерировать записи"
   - Все записи создаются сразу со статусом "Подтверждена"
   - Видит список всех созданных записей
   - Может редактировать отдельные записи при необходимости


СЦЕНАРИЙ 8: ПРОСМОТР ОТЧЕТНОСТИ

Шаг 1: Переход в раздел отчетности
   - Нажимает "Отчеты" или "Статистика" (если доступно)
   
Шаг 2: Просмотр статистики
   - Может видеть:
     * Самый посещаемый вид тренировки (в своем СЦ)
     * Самого активного клиента (в своем СЦ)
   - НЕ видит: самого прибыльного тренера и отчет по прибыли (ограничение прав)


СЦЕНАРИЙ 9: УПРАВЛЕНИЕ КОРТАМИ

Шаг 1: Просмотр кортов
   - В карточке СЦ переходит на вкладку "Теннисные корты"
   - Видит список всех кортов

Шаг 2: Создание корта
   - Нажимает "Создать"
   - Заполняет:
     * Название корта
     * Время работы берется из СЦ (readonly)
   - Сохраняет

Шаг 3: Редактирование корта
   - Открывает карточку корта
   - Может изменить название
   - Время работы нельзя изменить (берется из СЦ)


================================================================================
ПРОВЕРКА СООТВЕТСТВИЯ ТРЕБОВАНИЯМ ИЗ ТЗ
================================================================================

ПРОВЕРКА ПО ПУНКТАМ ТЗ (odoo18final.txt):

✓ П.9: Спортивный центр состоит из множества теннисных кортов
   - Реализовано: модель final.tennis.court связана с final.sport.center
   - Время работы кортов определяется временем работы СЦ ✓

✓ П.10: Клиенты СЦ - модель res.partner, Работники - hr.employee
   - Используем res.partner для клиентов ✓
   - Используем hr.employee для тренеров и менеджеров ✓

✓ П.11: У каждого СЦ есть один Менеджер
   - Реализовано: manager_id в final.sport.center ✓

✓ П.12: Тренера приписаны к определенному СЦ
   - Реализовано: модель final.center.trainer связывает тренера и СЦ ✓
   - Нужно добавить проверку: тренер не может быть в более чем одном СЦ

✓ П.13-16: 3 вида тренировок (Индивидуальная, Сплит, Группа)
   - Реализовано: модель final.training.type с кодами individual, split, group ✓
   - Ограничения по количеству клиентов: 1, 2, 3-5 ✓

✓ П.19: Запись может осуществляться Тренером или Менеджером
   - Реализовано в плане: wizard доступен обеим ролям ✓

✓ П.20: Общие правила записи:
   - Нельзя записаться на занятое время корта ✓ (валидация в плане)
   - Записи тренера требуют апрува менеджера ✓ (система апрувов)
   - Минимальное время 1ч, шаг 1 час ✓ (валидация)

✓ П.21: Визуализация свободных/занятых слотов
   - В плане: таймлайн в wizard записи ✓
   - Автоматическое присвоение тренера для записи тренера ✓
   - Выбор тренера для записи менеджера ✓
   - Выбор клиентов согласно ограничению ✓

✓ П.22: Запись только на рабочие часы корта
   - Валидация в модели final.training.booking ✓

✓ П.23: Карточка Тренировки и меню
   - В плане: модель final.training.booking с формой ✓
   - Меню для просмотра тренировок ✓

✓ П.24: Повторяющиеся тренировки
   - В плане: модель final.training.recurring ✓
   - Генерация по мере необходимости ✓

✓ П.25: Календарное расписание для тренера и менеджера
   - Calendar view в плане ✓
   - Тренер видит только свои ✓
   - Менеджер видит все своего СЦ ✓

✓ П.28: Ставка тренера за 1ч тренировки по видам
   - Реализовано: модель final.trainer.rate ✓

✓ П.29: Стоимость вида тренировки в СЦ
   - Реализовано: модель final.center.training.price ✓

✓ П.30: Подсчет суммы прибыли тренера
   - В плане: profit_amount = total_price - trainer_rate_amount ✓
   - Фильтры по датам ✓

✓ П.31: Аккумуляция прибыли по СЦ
   - В плане: суммирование profit_amount всех тренеров СЦ ✓

✓ П.32: Баланс клиента
   - В плане: баланс в res.partner ✓
   - Пополнение менеджером вручную ✓
   - Списание после окончания тренировки ✓
   - Ограничения при записи ✓

✓ П.33-36: Отчетность
   - В плане: отчеты по прибыльному тренеру, виду тренировки, активному клиенту ✓
   - Фильтры по датам ✓

✓ П.37: PDF отчет по прибыли
   - В плане: генерация PDF через отчеты Odoo ✓

✓ П.40-42: Ограничения по ролям
   - В плане: права доступа для каждой роли ✓
   - Менеджер не видит п.10 (ставки тренеров) - НУЖНО ПРОВЕРИТЬ
   - Менеджер не может печатать отчет - НУЖНО ПРОВЕРИТЬ
   - Тренер не видит финансовую информацию ✓

✓ П.43: Видимость СЦ и ТК
   - В плане: record rules для менеджера и тренера ✓

✓ П.45-47: Telegram бот
   - В плане: REST API для бота ✓
   - Просмотр баланса и тренировок ✓
   - Уведомления о записи и напоминания ✓

ЗАМЕЧАНИЯ И ДОПОЛНЕНИЯ:
1. П.12: Нужно добавить проверку что тренер не может быть в более чем одном СЦ одновременно
2. П.41: Нужно скрыть ставки тренеров от менеджера (видит только свою ставку или вообще не видит?)
3. П.41: Нужно запретить менеджеру печатать PDF отчет по прибыли
4. П.30: Нужно добавить отображение прибыли тренера по умолчанию с первого числа текущего месяца

================================================================================
ЗАМЕТКИ
================================================================================

- Все монетарные поля должны учитывать валюту
- Валидации должны быть строгими (занятость, баланс, время работы)
- Интерфейс должен быть интуитивным, особенно для тренера
- Telegram бот должен быть асинхронным для быстрой обработки запросов
- Cron-задачи должны быть оптимизированы по производительности
- При записи через тренера автоматически отправляется уведомление менеджеру на одобрение
- При завершении тренировки автоматически рассчитывается и списывается стоимость
- Баланс клиента проверяется перед подтверждением записи (если создает менеджер) или перед одобрением (если тренер)

================================================================================
